{% extends 'layouts/base.html' %}
{% load static %}

{% block extrastyle %}

    <style>
        .map-container {
            display: flex;
            width: 100%;
            height: 100%;
            flex-direction: column;
            overflow: hidden;
        }

        .parent-fit {
            flex-grow: 1;
            border: none;
            margin: 0;
            padding: 0;
            height: 100vh;
        }

    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css"/>
{% endblock extrastyle %}


{% block breadcrumbs %}{% endblock breadcrumbs %}

{% block content %}
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Leaflet map
            var map = L.map('map').setView([18.109656, -77.297565], 10);
            var spatialExtent = L.latLngBounds([17.7012, -78.3666], [18.5242, -76.199]);

            map.setMaxBounds(spatialExtent);

            // Add Tile layer (e.g., OpenStreetMap)
            L.tileLayer('http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }).addTo(map);

            var minimap = new L.Control.MiniMap(
                L.tileLayer('http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                    maxZoom: 14,

                }), {
                    toggleDisplay: true,
                    minimized: false
                }
            ).addTo(map);

            var temp_per;

            fetch('http://127.0.0.1:8000/calculate_weather/')
                .then(response => response.json())
                .then(data => {
                    var temperature = JSON.parse(data.temperature_2m);
                    var precipitation = data.precipitation;
                    var evapotranspiration = data.evapotranspiration;
                    var windSpeed = data.wind_speed_10m;
                    var soilTemperature = data.soil_temperature_6cm

                    let temp_date = temperature.map((item => item.date))
                    let temp_value = temperature.map((item => item.temperature_2m))
                    let temp_sum = temp_value.reduce((acc,curr)=>acc+curr,0);
                    let temp_avg =temp_sum / temp_value.length;
                    temp_per = (temp_avg).toFixed(2)


                    console.log(temp_value)

                    precipitation_date = temperature.map((item => item.date))
                    precipitation_value = temperature.map((item => item.precipitation))

                    console.log(temp_value)
                })



            fetch('http://127.0.0.1:8000/sensor_location/')
                .then(response => response.json())
                .then(location_data => {
                    console.log(location_data)
                    fetch('http://127.0.0.1:8000/sensor_dataset/')
                        .then(response => response.json())
                        .then(data => {
                            console.log(data)
                            for (const feature of location_data.features) {
                                for (const d of data) {
                                    const lat = feature.geometry.coordinates[1];
                                    const lng = feature.geometry.coordinates[0];
                                    const sensorGroupName = feature.properties.sensor_group_name;

                                    let avg_sensor_data = 0
                                    let count = 1
                                    for ( let i= 0 ; i<=data.length-1 ; i++ ){
                                       let  value = data[i].features[0].properties.sensor_data
                                        avg_sensor_data += value;
                                    }
                                    console.log(avg_sensor_data)
                                    avg_sensor_data = avg_sensor_data / 3

                                    avg_per = (avg_sensor_data * 10).toFixed(2)
                                    avg_value = (avg_sensor_data).toFixed(5)



                                    const popupContent = "<b>Sensor Group: " + feature.id + "</b><br><br> Current Moisture Sensor Reading: "
                                        +avg_per +  "% <br>" +  "Ambient Temperature: "+temp_per +"°C <br>"+ "Soil Temperature: " + "°C <br>" + "Precipitation: "  ;
                                    var marker = L.marker([lat, lng]).addTo(map);
                                    if (popupContent) {
                                        marker.bindPopup(popupContent);
                                    }

                                    var circle =  L.circle([lat, lng], {radius: 900}).addTo(map)

                                }
                            }
                        });
                });
        });
    </script>



    <div class="row">
        <div class="col-md-12">
            <div class="map-container">
                <div onload="init()" id="map" class="map parent-fit"></div>
            </div>
        </div>
    </div>

{% endblock %}