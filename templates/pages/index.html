{% extends 'layouts/base.html' %}
{% load static %}

{% block extrastyle %}
    <script src="{% static 'assets/js/pages/chart-js.js' %}"></script>
    <!-- morris css -->
    <link rel="stylesheet" href="{% static 'assets/plugins/chart-morris/css/morris.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    {#    <script src="{% static 'assets/plugins/chartjs/chart-js.js' %}"></script>#}
{% endblock extrastyle %}

{% block content %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            fetch('http://127.0.0.1:8000/get_day_avg_sensor_data/')
                .then(response => response.json())
                .then(daily_sensor_avg => {
                    avg_per = (daily_sensor_avg.average_sensor_data * 100).toFixed(2)
                    avg_value = (daily_sensor_avg.average_sensor_data).toFixed(5)

                    document.getElementById("daily_avg_percentage").innerHTML = avg_per + " %";
                    document.getElementById("daily_avg_value").innerHTML = avg_value;
                    if (avg_per > 50) {
                        document.getElementById("daily_avg_icon").classList.add("icon-arrow-up")
                        document.getElementById("daily_avg_icon").classList.add("text-c-green")

                    } else {
                        document.getElementById("daily_avg_icon").classList.add("icon-arrow-down")
                        document.getElementById("daily_avg_icon").classList.add("text-c-red")
                    }
                    document.getElementById("daily_progress_bar").ariaValueNow = avg_per
                    document.getElementById("daily_progress_bar").style.width = avg_per + "%"

                    new Chart(document.getElementById('daily_pie_chart'), {
                        type: 'pie',
                        data: {
                            labels: ["Daily Average Moisture Content"],
                            datasets: [{
                                data: [avg_per, avg_per - 100],
                                backgroundColor: [
                                    'rgb(109,130,248)',
                                    'rgb(243,238,199)',
                                ],
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            animation: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: true
                                }

                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });


        });

        fetch('http://127.0.0.1:8000/sensor_dataset/')
            .then(response => response.json())
            .then(data => {
                let avg_sensor_data = 0

                for (const d of data) {

                    let count = 1
                    for (let i = 0; i <= data.length - 1; i++) {
                        let value = data[i].features[0].properties.sensor_data
                        avg_sensor_data += value;
                    }
                    avg_sensor_data = avg_sensor_data / count

                    avg_per = (avg_sensor_data * 10).toFixed(2)
                    avg_value = (avg_sensor_data).toFixed(5)

                    document.getElementById("current_avg_percentage").innerHTML = avg_per + " %";
                    document.getElementById("current_avg_value").innerHTML = avg_value;
                    if (avg_per > 50) {
                        document.getElementById("current_avg_icon").classList.add("icon-arrow-up")
                        document.getElementById("current_avg_icon").classList.add("text-c-green")

                    } else {
                        document.getElementById("current_avg_icon").classList.add("icon-arrow-down")
                        document.getElementById("current_avg_icon").classList.add("text-c-red")
                    }
                    document.getElementById("current_progress_bar").ariaValueNow = avg_per
                    document.getElementById("current_progress_bar").style.width = avg_per + "%"
                }

                new Chart(document.getElementById('current_pie_chart'), {
                    type: 'pie',
                    data: {
                        labels: ["Current Average Moisture Content"],
                        datasets: [{
                            data: [avg_per, avg_per - 100],
                            backgroundColor: [
                                'rgb(101,227,106)',
                                'rgb(219,199,243)',
                            ],
                            borderWidth: 1,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        animation: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });

        {#Monthly Sensor #}
        fetch('http://127.0.0.1:8000/average_reading_past_week/')
            .then(response => response.json())
            .then(weekly_sensor_avg => {
                const dates = Object.keys(weekly_sensor_avg);
                const avg_readings = Object.values(weekly_sensor_avg);

                // Calculate the total average reading
                const totalAvg = avg_readings.reduce((acc, val) => acc + val, 0) / avg_readings.length;

                // Update the average percentage and value
                const avg_per = (totalAvg * 100).toFixed(2);
                const avg_value = totalAvg.toFixed(5);
                document.getElementById("monthly_avg_percentage").innerHTML = avg_per + " %";
                document.getElementById("monthly_avg_value").innerHTML = avg_value;

                // Update the progress bar
                const progress_bar = document.getElementById("monthly_progress_bar");
                progress_bar.ariaValueNow = avg_per;
                progress_bar.style.width = avg_per + "%";
                if (avg_per > 50) {
                    progress_bar.classList.add("text-c-green");
                } else {
                    progress_bar.classList.add("text-c-red");
                }

                // Create the histogram chart
                new Chart(document.getElementById('monthly_pie_chart'), {
                    type: 'bar',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Average Reading',
                            data: avg_readings,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Average Reading'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                callbacks: {
                                    label: function (context) {
                                        return 'Average Reading: ' + context.parsed.y.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });


    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("sensorForm");
            const select = document.getElementById("sensor_group_select");

            select.addEventListener("change", function () {
                const formData = new FormData(form);
                const selectedOption = select.options[select.selectedIndex];
                const x = selectedOption.dataset.x;
                const y = selectedOption.dataset.y;

                // Check if x and y are valid numbers
                if (!isNaN(parseFloat(x)) && !isNaN(parseFloat(y))) {
                    formData.append('x', x);
                    formData.append('y', y);

                    fetch('http://127.0.0.1:8000/calculate_weather/', {
                        method: 'POST',
                        body: formData,
                    })
                        .then(response => {

                            document.getElementById("precipitation_probability_value") = data.features[
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.text();
                        })
                        .then(data => {
                            // Handle successful response
                            console.log('Data successfully sent:', data);
                        })
                        .catch(error => {
                            // Handle fetch operation errors
                            console.error('There was a problem with the fetch operation:', error);
                        });
                } else {
                    // Handle invalid x or y values
                    console.error('Invalid x or y values:', x, y);
                }
            });
        });
    </script>


    <!-- [ Main Content ] start -->
    <div class="card-header">
        <h5>Soil Mositure Data</h5>

        <div class="row">

            <!--[ daily sales section ] start-->
            <div class="col-md-6 col-xl-4">
                <div class="card daily-sales">
                    <div class="card-block">
                        <h6 class="mb-4">Daily Island Wide Average</h6>
                        <div class="row d-flex align-items-center">
                            <div class="col-9">
                                <h3 class="f-w-300 d-flex align-items-center m-b-0">

                                    <i id="daily_avg_icon" class="feather text-c-green f-30 m-r-10"></i>
                                    <span id="daily_avg_percentage"></span>

                            </div>
                            <div>
                                <canvas id="daily_pie_chart"></canvas>
                            </div>

                            {% comment %} Update This {% endcomment %}
                            <div class="col-3 text-right">
                                <p id="daily_avg_value" class="m-b-0"></p>
                            </div>
                        </div>
                        <div class="progress m-t-30" style="height: 7px;">
                            <div id="daily_progress_bar" class="progress-bar progress-c-theme" role="progressbar"
                                 aria-valuenow=aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!--[ daily sales section ] end-->
            <!--[ Current  sales section ] starts-->
            <div class="col-md-6 col-xl-4 py-0">
                <div class="card current-sales">
                    <div class="card-block">
                        <h6 class="mb-4">Current Island Wide Average</h6>
                        <div class="row d-flex align-items-center">
                            <div class="col-9">
                                <h3 class="f-w-300 d-flex align-items-center m-b-0">
                                    <i id="current_avg_icon" class="feather  f-30 m-r-10"></i>
                                    <span id="current_avg_percentage"></span>
                            </div>
                            <div>
                                <div>
                                    <canvas id="current_pie_chart"></canvas>
                                </div>
                            </div>
                            <div class="col-3 text-right">
                                <p id="current_avg_value" class="m-b-0"></p>
                            </div>
                        </div>
                        <div class="progress m-t-30" style="height: 7px;">
                            <div id="current_progress_bar" class="progress-bar progress-c-theme" role="progressbar"
                                 aria-valuenow=aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!--[ Monthly  sales section ] end-->
            <!--[ year  sales section ] starts-->
            <div class="col-md-6 col-xl-4">
                <div class="card current-sales">
                    <div class="card-block">
                        <h6 class="mb-4">Daily Average For The Past 7 Days </h6>
                        <div class="row d-flex align-items-center">
                            <div class="col-9">
                                <h3 class="f-w-300 d-flex align-items-center m-b-0">
                                    <i id="monthly_avg_icon" class="feather  f-30 m-r-10"></i>
                                    <span id="monthly_avg_percentage"></span>
                                </h3>
                            </div>
                            <div class="col-9">
                                <div>
                                    <canvas id="monthly_pie_chart"></canvas>
                                </div>
                            </div>
                            <div class="col-3 text-right">
                                <p id="monthly_avg_value" class="m-b-0"></p>
                            </div>
                        </div>
                        <div class="progress m-t-30" style="height: 7px;">
                            <div id="monthly_progress_bar" class="progress-bar progress-c-theme" role="progressbar"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>

            <br>
            <!--[ year  sales section ] end-->

            <div class="card-header">
                <h5>Secondary Data</h5>
                <div class="container">
                    <div class="row">
                        <div class="col-md-2 col-xl-6 d-flex justify-content-start">
                            <form id="sensorForm" method="post">
                                {% csrf_token %}
                                <label for="sensor_group_select">Sensor Group Location</label>
                                <select required class="form-control" id="sensor_group_select"
                                        name="sensor_group_select">
                                    <option value=""></option>
                                    {% for sensor_group in sensor_group_names %}
                                        <option value="{{ sensor_group }}"
                                                data-x="{{ sensor_group.sensor_group_location.y }}"
                                                data-y="{{ sensor_group.sensor_group_location.x }}">
                                            {{ sensor_group.sensor_group_name }}
                                        </option>

                                    {% endfor %}
                                </select>
                            </form>
                        </div>

                        <a class="col-md-2 col-xl-5 d-flex justify-content-end">
                            <p class="m-0 mr-2">Data Queried from</p>
                            <a href="https://open-meteo.com/"> <img src="https://open-meteo.com/favicon-32x32.png"
                                                                    alt="Open Meteo" class="align-self-center">
                            </a>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 col-xs-6 col-xl-5"><br><br>
                        <div class="card yearly-sales">
                            <div class="card-block">
                                <h6 class="mb-4">Precipitation Probability</h6>
                                <div class="row d-flex align-items-center">
                                    <div class="col-9">
                                        <h3 class="f-w-300 d-flex align-items-center  m-b-0">

                                            <div class="col-3 text-right">
                                                <p id="precipitation_probability_value" class="m-b-0"></p>
                                            </div>

                                    </div>
                                    <div class="col-3 text-right">
                                        {% comment %} Update Here{% endcomment %}
                                        <p class="m-b-0">{{ yearly_avg_percentage }}%</p>
                                    </div>
                                </div>
                                <div class="progress m-t-30" style="height: 7px;">
                                    <div class="progress-bar progress-c-theme" role="progressbar"
                                         style="width: {{ yearly_avg_percentage }}%;"
                                         aria-valuenow="70" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="row">
                        <div class="col-md-6 col-xs-6 col-xl-5"><br><br>
                            <div class="card yearly-sales">
                                <div class="card-block">
                                    <h6 class="mb-4">Relative Humidity</h6>
                                    <div class="row d-flex align-items-center">
                                        <div class="col-9">
                                            <h3 class="f-w-300 d-flex align-items-center  m-b-0">

                                                {% if daily_avg > 45 %}
                                                    <i class="feather icon-arrow-up text-c-green f-30 m-r-10"></i>
                                                    {{ yearly_avg }}
                                                    </h3>
                                                {% else %}
                                                    <i class="feather icon-arrow-down text-c-red f-30 m-r-10"></i>
                                                    {{ yearly_avg }}
                                                    </h3>
                                                {% endif %}

                                        </div>
                                        <div class="col-3 text-right">
                                            {% comment %} Update Here{% endcomment %}
                                            <p class="m-b-0">{{ yearly_avg_percentage }}%</p>
                                        </div>
                                    </div>
                                    <div class="progress m-t-30" style="height: 7px;">
                                        <div class="progress-bar progress-c-theme" role="progressbar"
                                             style="width: {{ yearly_avg_percentage }}%;"
                                             aria-valuenow="70" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-xs-6 col-xl-5"><br><br>
                            <div class="card yearly-sales">
                                <div class="card-block">
                                    <h6 class="mb-4">Precipitation</h6>
                                    <div class="row d-flex align-items-center">
                                        <div class="col-9">
                                            <h3 class="f-w-300 d-flex align-items-center  m-b-0">

                                                {% if daily_avg > 45 %}
                                                    <i class="feather icon-arrow-up text-c-green f-30 m-r-10"></i>
                                                    {{ yearly_avg }}
                                                    </h3>
                                                {% else %}
                                                    <i class="feather icon-arrow-down text-c-red f-30 m-r-10"></i>
                                                    {{ yearly_avg }}
                                                    </h3>
                                                {% endif %}

                                        </div>
                                        <div class="col-3 text-right">
                                            {% comment %} Update Here{% endcomment %}
                                            <p class="m-b-0">{{ yearly_avg_percentage }}%</p>
                                        </div>
                                    </div>
                                    <div class="progress m-t-30" style="height: 7px;">
                                        <div class="progress-bar progress-c-theme" role="progressbar"
                                             style="width: {{ yearly_avg_percentage }}%;"
                                             aria-valuenow="70" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-2 col-xl-4">
                            <div class="card yearly-sales">
                                <div class="card-block">
                                    <h6 class="mb-4">Hourly Temperature Reading </h6>
                                    <div class="row d-flex align-items-center">
                                        <div class="col-9">
                                            <h3 class="f-w-300 d-flex align-items-center  m-b-0">

                                                {% if daily_avg > 45 %}
                                                    <i class="feather icon-arrow-up text-c-green f-30 m-r-10"></i>
                                                    {{ yearly_avg }}
                                                    </h3>
                                                {% else %}
                                                    <i class="feather icon-arrow-down text-c-red f-30 m-r-10"></i>
                                                    {{ yearly_avg }}
                                                    </h3>
                                                {% endif %}

                                        </div>
                                        <div class="col-3 text-right">
                                            {% comment %} Update Here{% endcomment %}
                                            <p class="m-b-0">{{ yearly_avg_percentage }}%</p>
                                        </div>
                                    </div>
                                    <div class="progress m-t-30" style="height: 7px;">
                                        <div class="progress-bar progress-c-theme" role="progressbar"
                                             style="width: {{ yearly_avg_percentage }}%;"
                                             aria-valuenow="70" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-2 col-xl-4">
                            <div class="card yearly-sales">
                                <div class="card-block">
                                    <h6 class="mb-4">Evapotranspiration</h6>
                                    <div class="row d-flex align-items-center">
                                        <div class="col-9">
                                            <h3 class="f-w-300 d-flex align-items-center  m-b-0">

                                                {% if daily_avg > 45 %}
                                                    <i class="feather icon-arrow-up text-c-green f-30 m-r-10"></i>
                                                    {{ yearly_avg }}
                                                    </h3>
                                                {% else %}
                                                    <i class="feather icon-arrow-down text-c-red f-30 m-r-10"></i>
                                                    {{ yearly_avg }}
                                                    </h3>
                                                {% endif %}

                                        </div>
                                        <div class="col-3 text-right">
                                            {% comment %} Update Here{% endcomment %}
                                            <p class="m-b-0">{{ yearly_avg_percentage }}%</p>
                                        </div>
                                    </div>
                                    <div class="progress m-t-30" style="height: 7px;">
                                        <div class="progress-bar progress-c-theme" role="progressbar"
                                             style="width: {{ yearly_avg_percentage }}%;"
                                             aria-valuenow="70" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-2 col-xl-4">
                            <div class="card yearly-sales">
                                <div class="card-block">
                                    <h6 class="mb-4">Wind Speeds</h6>
                                    <div class="row d-flex align-items-center">
                                        <div class="col-9">
                                            <h3 class="f-w-300 d-flex align-items-center  m-b-0">

                                                {% if daily_avg > 45 %}
                                                    <i class="feather icon-arrow-up text-c-green f-30 m-r-10"></i>
                                                    {{ yearly_avg }}
                                                    </h3>
                                                {% else %}
                                                    <i class="feather icon-arrow-down text-c-red f-30 m-r-10"></i>
                                                    {{ yearly_avg }}
                                                    </h3>
                                                {% endif %}

                                        </div>
                                        <div class="col-3 text-right">
                                            {% comment %} Update Here{% endcomment %}
                                            <p class="m-b-0">{{ yearly_avg_percentage }}%</p>
                                        </div>
                                    </div>
                                    <div class="progress m-t-30" style="height: 7px;">
                                        <div class="progress-bar progress-c-theme" role="progressbar"
                                             style="width: {{ yearly_avg_percentage }}%;"
                                             aria-valuenow="70" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- [ statistics year chart ] start -->
                <!-- [ Main Content ] end -->



{% endblock content %}